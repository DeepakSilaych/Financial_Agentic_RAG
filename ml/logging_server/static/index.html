<!DOCTYPE html>
<html>
<head>
    <title>Live Logging Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .controls {
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: #f5f5f5;
            padding: 10px 0;
            z-index: 100;
            border-bottom: 1px solid #ddd;
        }
        button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #2196F3;
            color: white;
        }
        button:hover {
            background-color: #1976D2;
        }
        #filterInput {
            padding: 8px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .log-group {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .group-header {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 2px solid #eee;
            margin: -20px -20px 10px -20px;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-title {
            color: #333;
            display: flex;
            align-items: center;
        }
        .group-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .group-stats {
            font-size: 0.8em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .log-entries {
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: baseline;
        }
        .log-entry:hover {
            background-color: #f8f8f8;
        }
        .timestamp {
            color: #666;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .level {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .INFO { 
            color: #2196F3;
            background-color: #E3F2FD;
        }
        .WARNING { 
            color: #FF9800;
            background-color: #FFF3E0;
        }
        .ERROR { 
            color: #F44336;
            background-color: #FFEBEE;
        }
        .component {
            color: #4CAF50;
            background-color: #E8F5E9;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .message {
            flex: 1;
            min-width: 200px;
        }
        .metadata {
            font-size: 0.9em;
            color: #666;
            margin-left: 20px;
        }
        .collapse-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2em;
        }
        .collapse-btn:hover {
            color: #333;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="clearLogs()">Clear All Logs</button>
        <button onclick="toggleAutoScroll()" id="autoScrollBtn">Auto-scroll: ON</button>
        <input type="text" id="filterInput" placeholder="Filter logs..." oninput="filterLogs()">
    </div>
    <div id="logGroups"></div>

    <script>
        let autoScroll = true;
        const logGroups = {};
        const logGroupsContainer = document.getElementById('logGroups');
        const ws = new WebSocket('ws://localhost:8000/ws');

        const GROUP_ICONS = {
            'question': '‚ùì',
            'track': 'üõ§Ô∏è',
            'component': 'üîß',
            'system': '‚öôÔ∏è'
        };

        ws.onmessage = function(event) {
            console.log('Received message:', event.data);
            const data = JSON.parse(event.data);
            addLogEntry(data.log, data.group_key, data.group_title);
        };

        ws.onopen = function() {
            console.log('WebSocket Connected');
            addSystemLog('WebSocket connection established', 'INFO');
        };

        ws.onerror = function(error) {
            console.error('WebSocket Error:', error);
            addSystemLog('WebSocket connection error', 'ERROR');
        };

        ws.onclose = function() {
            console.log('WebSocket Closed');
            addSystemLog('WebSocket connection closed', 'WARNING');
            // Try to reconnect after 5 seconds
            setTimeout(function() {
                window.location.reload();
            }, 5000);
        };

        function addSystemLog(message, level) {
            const systemLog = {
                timestamp: new Date().toISOString(),
                level: level,
                component: 'system',
                message: message
            };
            addLogEntry(systemLog, 'system_general', 'System Logs');
        }

        function getGroupIcon(group_key) {
            const category = group_key.split('_')[0];
            return GROUP_ICONS[category] || 'üìù';
        }

        function getOrCreateLogGroup(groupKey, groupTitle) {
            if (!logGroups[groupKey]) {
                // Create new group container
                const groupDiv = document.createElement('div');
                groupDiv.className = 'log-group';
                groupDiv.id = `group-${groupKey}`;

                // Create group header
                const header = document.createElement('div');
                header.className = 'group-header';

                header.innerHTML = `
                    <div class="group-title">
                        <span class="group-icon">${getGroupIcon(groupKey)}</span>
                        ${groupTitle}
                    </div>
                    <div class="group-stats">
                        <span class="log-count">0 logs</span>
                        <button class="collapse-btn" onclick="toggleGroup('${groupKey}')">‚ñº</button>
                    </div>
                `;

                // Create log entries container
                const entriesDiv = document.createElement('div');
                entriesDiv.className = 'log-entries';
                entriesDiv.id = `entries-${groupKey}`;

                groupDiv.appendChild(header);
                groupDiv.appendChild(entriesDiv);
                logGroupsContainer.insertBefore(groupDiv, logGroupsContainer.firstChild);
                
                logGroups[groupKey] = {
                    container: groupDiv,
                    entries: entriesDiv,
                    count: 0
                };
            }
            return logGroups[groupKey];
        }

        function formatMetadata(log) {
            let metadata = [];
            if (log.question_id) metadata.push(`Question: ${log.question_id}`);
            if (log.track) metadata.push(`Track: ${log.track}`);
            if (log.metadata) {
                for (const [key, value] of Object.entries(log.metadata)) {
                    metadata.push(`${key}: ${value}`);
                }
            }
            return metadata.length ? `[${metadata.join(' | ')}]` : '';
        }

        function addLogEntry(log, groupKey, groupTitle) {
            const group = getOrCreateLogGroup(groupKey, groupTitle);
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const metadata = formatMetadata(log);
            entry.innerHTML = `
                <span class="timestamp">${new Date(log.timestamp).toISOString()}</span>
                <span class="level ${log.level}">${log.level}</span>
                <span class="component">${log.component}</span>
                <span class="message">${log.message}</span>
                ${metadata ? `<span class="metadata">${metadata}</span>` : ''}
            `;
            
            const filterText = document.getElementById('filterInput').value.toLowerCase();
            if (filterText === '' || entry.textContent.toLowerCase().includes(filterText)) {
                group.entries.insertBefore(entry, group.entries.firstChild);
                group.count++;
                updateGroupStats(groupKey);
            }

            if (autoScroll) {
                group.entries.scrollTop = 0;
            }
        }

        function updateGroupStats(groupKey) {
            const group = logGroups[groupKey];
            const statsElement = group.container.querySelector('.log-count');
            statsElement.textContent = `${group.count} logs`;
        }

        function toggleGroup(groupKey) {
            const entriesDiv = document.getElementById(`entries-${groupKey}`);
            const button = document.querySelector(`#group-${groupKey} .collapse-btn`);
            
            if (entriesDiv.style.display === 'none') {
                entriesDiv.style.display = 'block';
                button.textContent = '‚ñº';
            } else {
                entriesDiv.style.display = 'none';
                button.textContent = '‚ñ∂';
            }
        }

        function clearLogs() {
            logGroupsContainer.innerHTML = '';
            for (const key in logGroups) {
                delete logGroups[key];
            }
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('autoScrollBtn').textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
        }

        function filterLogs() {
            const filterText = document.getElementById('filterInput').value.toLowerCase();
            const entries = document.getElementsByClassName('log-entry');
            
            for (let entry of entries) {
                const visible = entry.textContent.toLowerCase().includes(filterText);
                entry.style.display = visible ? 'block' : 'none';
            }
        }
    </script>
</body>
</html>
